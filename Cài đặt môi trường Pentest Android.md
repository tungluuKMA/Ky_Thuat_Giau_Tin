# Cài đặt môi trường Pentest Android

# Windows Subsystem for Android

Windows Subsystem for Android (WSA) là một nền tảng công nghệ mới trên Windows 11, nó hỗ trợ chạy trực tiếp các ứng dụng Android thông qua Amazon Appstore trên Windows 11 mà không cần phải cài thêm phần mềm giả lập Android.

## **+ Bước 1:** Cài đặt WSA

Truy cập github ([https://github.com/creative-builds/WSA-Magisk/releases](https://github.com/creative-builds/WSA-Magisk/releases)) và chọn cài đặt phiên bản x64 Release-Night-with-masigk-…-stable-MindTheGapps dành cho Windows.

[https://github.com/creative-builds/WSA-Magisk/releases/download/v2023-08-01/WSA_2305.40000.6.0_x64_Release-Nightly-with-magisk-26.1.26100.-stable-MindTheGapps-13.0-RemovedAmazon.7z](https://github.com/creative-builds/WSA-Magisk/releases/download/v2023-08-01/WSA_2305.40000.6.0_x64_Release-Nightly-with-magisk-26.1.26100.-stable-MindTheGapps-13.0-RemovedAmazon.7z)

![Untitled](Cài%20đặt%20môi%20trường%20Pentest%20Android/Untitled.png?raw=true)

Sau khi tải về xong, mở thư mục vừa tải và chạy file run.bat. File này sẽ chạy file Install.ps1 để cài đặt các cấu hình cần thiết, hoặc chúng ta có thể chạy trực tiếp file Install.ps1 bằng powershell.

![Untitled](Cài%20đặt%20môi%20trường%20Pentest%20Android/Untitled%201.png?raw=true)

Sau khi quá trình cài đặt hoàn tất, chúng ta đã cài thành công WSA cùng với Magisk, đi kèm với đó là Play Store để cài đặt các ứng dụng cần thiết. Bây giờ chúng ta chỉ cần vào Play Store và cài các ứng dụng mong muốn và sử dụng.

Tuy nhiên sẽ khó quản lý các ứng dụng cũng như cấu hình máy ảo khi không có một giao diện android cụ thể. Vì vậy tiếp theo sẽ cài đặt Windows Launcher

![Untitled](Cài%20đặt%20môi%20trường%20Pentest%20Android/Untitled%202.png?raw=true)

Sau khi cài đặt thành công, mở phần mềm Windows Subsystem for Android và bật chế độ Developer Mode. Lưu ý địa chỉ ip này sẽ dùng để connect adb

![Untitled](Cài%20đặt%20môi%20trường%20Pentest%20Android/Untitled%203.png?raw=true)

## **+ Bước 2:** Cài đặt Certificate

Vì đã có sẵn công cụ Magisk, nên việc cài đặt chứng chỉ sẽ dễ dàng hơn rất nhiều nhờ vào ***Magisk Trust User Certs.*** Module này sẽ đưa tất cả user certificate đã cài đặt thành và trong system certificate. 

Tải AlwayTrustUserCerts.zip tại github sau: [https://github.com/NVISOsecurity/MagiskTrustUserCerts/releases/tag/v0.4.1](https://github.com/NVISOsecurity/MagiskTrustUserCerts/releases/tag/v0.4.1)

Sử dụng BurpSuite để export ra Certificate ( Có thể dùng định dạng DER hay PEM đều được)

![Untitled](Cài%20đặt%20môi%20trường%20Pentest%20Android/Untitled%204.png?raw=true)

Sau đó sử dụng adb để kết nối tới devices thông qua câu lệnh:

```powershell
adb connect 127.0.0.1:58526
```

Tiếp đến chúng ta sẽ đưa tệp zip trên cùng với certificate được export từ BurpSuite vào trong kho lưu trữ của thiết bị Android.

![Untitled](Cài%20đặt%20môi%20trường%20Pentest%20Android/Untitled%205.png?raw=true)

Sau đó mở Magisk, chọn modules và chọn ***Install from storage*** và lựa chọn tệp *AlwayTrustUserCert.zip* vừa được đưa vào.

![Untitled](Cài%20đặt%20môi%20trường%20Pentest%20Android/Untitled%206.png?raw=true)

<aside>
💡 Fix lỗi Cert Alwaytrustuser bị mất khi reboot WSA
+ B1: Sử dụng Magisk Install cert
+ B2: Kết nối adb shell
+ B3: Copy all files and overwrite from /data/adb/modules_update/(your installed module) to /data/adb/modules/(your installed module)
+ B4: DELETE the file called "update" from /data/adb/modules/(your installed module)
+ B5:  Repeat the same steps on other modules. When you are done, DELETE the modules_update folder
+ B6: Reboot WSA via Magisk app

</aside>

Như vậy là ta đã cài thành công. Tiếp đến là cài đặt BurpSuite certificate

Mở ứng dụng Microsoft Launcher, chọn ***Setting > Security > More Security Setting > Encryption & credential > Install a Certificate.*** Lựa chọn ***CA certificate*** và chọn Install anyway. Chọn Install BurpSuite certificate đã được đưa vào ở bước trên

![Untitled](Cài%20đặt%20môi%20trường%20Pentest%20Android/Untitled%207.png?raw=true)

Thông báo cài đặt thành công. Truy cập ***Trusted Credentials*** và chọn tab User để kiểm tra

![Untitled](Cài%20đặt%20môi%20trường%20Pentest%20Android/Untitled%208.png?raw=true)

Đồng thời bên tab system, certificate đã được tự động thêm vào ( Restart lại WSA nếu chưa có)

![Untitled](Cài%20đặt%20môi%20trường%20Pentest%20Android/Untitled%209.png?raw=true)

## **+ Bước 3:** Cấu hình Proxy

Mở Microsoft Launcher. Chọn ***Setting > Internet.*** Bấm biểu tượng cài đặt của mạng wifi đang sử dụng

![Untitled](Cài%20đặt%20môi%20trường%20Pentest%20Android/Untitled%2010.png?raw=true)

Kiểm tra các interface tồn tại trên máy mà BurpSuite có thể lắng nghe, ta có thể sử dụng bất kì interface nào nếu muốn.

![Untitled](Cài%20đặt%20môi%20trường%20Pentest%20Android/Untitled%2011.png?raw=true)

Cấu hình địa chỉ Proxy của máy ảo cho đi qua địa chỉ 192.168.100.1, port 8080

![Untitled](Cài%20đặt%20môi%20trường%20Pentest%20Android/Untitled%2012.png?raw=true)

Cấu hình BurpSuite lắng nghe ở mọi interfaces

Sử dụng ứng dụng bất kỳ, có thể thấy các request của ứng dụng đã đi qua BurpSuite. Như vậy chúng ta đã xây dựng thành công môi trường kiểm thử cho ứng dụng trên thiết bị Android bằng công cụ Windows Subsystem for Android

# Android Virtual Devices ( Android Studio)

## + Bước 1: Cài đặt Android Studio.

Truy cập trang chủ của android studio và chọn mục Download. Sau đó tải file và cài đặt

Chọn mục Android Virtual Device để cài đặt ADV cùng với Android Studio

![Untitled](Cài%20đặt%20môi%20trường%20Pentest%20Android/Untitled%2013.png?raw=true)

## + Bước 2: Cài đặt ADV

Sau khi quá trình cài đặt ứng dụng hoàn tất. Chọn *More Action* và chọn *Virtual Device Manager* 

![Untitled](Cài%20đặt%20môi%20trường%20Pentest%20Android/Untitled%2014.png?raw=true)

Thiết lập các cấu hình cho máy ảo android. ( Recommend: Pixel 5, API 31)

![Untitled](Cài%20đặt%20môi%20trường%20Pentest%20Android/Untitled%2015.png?raw=true)

![Untitled](Cài%20đặt%20môi%20trường%20Pentest%20Android/Untitled%2016.png?raw=true)

Cài đặt thành công

![Untitled](Cài%20đặt%20môi%20trường%20Pentest%20Android/Untitled%2017.png?raw=true)

## **+ Bước 4:** Cài đặt Certificate

[https://www.notion.so/bcpentest/C-i-cacert-Android-557675942dd545e097af965838d648c7](Cài%20cacert%20Android.md)

## + Bước 5: Cài đặt proxy

![Untitled](Cài%20đặt%20môi%20trường%20Pentest%20Android/Untitled%2018.png?raw=true)

Chọn tab ***Setting > Proxy***

![Untitled](Cài%20đặt%20môi%20trường%20Pentest%20Android/Untitled%2019.png?raw=true)

Mặc định tại BurpSuite sẽ lắng nghe qua localhost port 8080, cấu hình Proxy của máy android cho đi qua locahost.
Khởi chạy một ứng dụng bất kỳ, có thể thấy các request đi qua mạng đã được bắt lại thành công ở BurpSuite, như vậy chúng ta đã cài đặt thành công môi trường để kiểm thử ứng dụng trên thiết bị Android bằng công cụ Android Studio

![Untitled](Cài%20đặt%20môi%20trường%20Pentest%20Android/Untitled%2020.png?raw=true)

# Android Virtual Devices with PlayStore ( Android Studio)

### Tải và cài Android Studio bản mới nhất

Truy cập [https://developer.android.com/studio](https://developer.android.com/studio), tải về bản mới nhất và cài đặt

### Tạo thiết bị mới có hỗ trợ PlayStore

![Untitled](Cài%20đặt%20môi%20trường%20Pentest%20Android/Untitled%2021.png?raw=true)

### Root thiết bị

[https://gitlab.com/newbit/rootAVD](https://gitlab.com/newbit/rootAVD)

### Cài Cert BurpSuite

Xuất file Cert BurpSuite, sau đó sử dụng lệnh dưới để xuất file `9a5ba575.0`

```jsx
openssl x509 -inform der -in cacert.der -out 9a5ba575.0
```

Ghi đè file 9a5ba575.0 lấy được vào file zip dưới đây, sau đó cài zip với Magisk bên trong máy ảo.

[BurpCertInstaller.zip](Cài%20đặt%20môi%20trường%20Pentest%20Android/BurpCertInstaller.zip?raw=true)